프로젝트 기획 및 개발 문서 (Blueprint)

1. 문제 정의 (40점)

(1) 해결하려는 문제
시중에 존재하는 대부분의 대출 계산기는 단순히 정해진 금리와 기간에 따른 월 상환액만 알려줄 뿐, 실제 대출 과정에서 발생하는 복잡한 변수들을 제대로 반영하지 못함. 예를 들어, 거치기간을 두거나, 중간에 목돈이 생겨 중도 상환을 하거나, 혹은 금리가 변동되는 상황을 시뮬레이션하기 어려움.

이로 인해 사용자는 자신의 재정 상황에 가장 유리한 상환 전략을 세우는 데 한계를 느끼며, 더 나은 금융적 선택을 할 기회를 놓치게 됨. 특히, 현재 자신의 대출 조건이 시장의 다른 상품에 비해 경쟁력이 있는지 판단하기 어려워, 불필요하게 높은 이자를 계속 납부하는 경우가 많음.

본 프로젝트는 이러한 정보의 비대칭성과 계산의 복잡성을 해결하여, 사용자가 대출의 전체 생애주기를 명확하게 예측하고, '잠재적인 금융 비용을 최소화할 수 있는 의사결정을 내리도록 돕는 것'을 핵심 문제로 정의.

(2) 문제 선택 근거
"대출 관리"라는 주제 안에서 '상환 전략 비교'와 '대환대출' 키워드에 집중. 
  -단순히 빚을 기록하는 것을 넘어, 사용자의 실질적인 금융 부담을 줄여줄 수 있는 "실행 가능한(actionable) 정보"를 제공하는 것이 가장 큰 가치를 창출한다고 판단. 
  - 금리 비교 플랫폼은 많지만, 개인의 복잡한 상환 시나리오를 반영하여 대환의 실익을 구체적인 절감액으로 보여주는 서비스는 부족하다는 점에서 문제 해결의 필요성을 느낌.
 (3) 핵심 기능과 부가 기능
- 핵심 기능:
    1.  3가지 상환 방식 비교: 원리금 균등, 원금 균등, 만기일시 상환 방식에 따른 총이자, 총상환액, 월평균 상환액을 동시에 계산하고 표로 비교.
    2.  복합 시나리오 시뮬레이션: 거치기간, 중도상환, 금리 변동 등 여러 이벤트를 조합하여 상세 상환 스케줄을 동적으로 재계산.

- 부가 기능 (차별화 포인트):
    1.  지능형 대환대출 제안: 사용자의 금리가 시장 평균보다 높을 경우, 대환대출 시 예상 절감액을 구체적인 금액으로 제시.
    2.  개인화된 금융 조언: 금리 수준에 따라 "금리가 높은 편이에요" 와 같은 직관적인 메시지 제공.
    3.  외부 플랫폼 연계: 주요 대환대출 서비스로 바로 이동할 수 있는 링크 제공.
    4.  뛰어난 UX/UI: 복잡한 정보를 단계적으로 노출하고, 인터랙티브한 입력을 통해 사용 편의성을 극대화.

(4) 대상 사용자 및 시나리오
- 대상 사용자: "노아" - 생애 첫 주택담보대출 또는 신용대출을 받으려는 사회초년생 및 신혼부부. 금융 지식은 많지 않지만, 합리적인 소비와 재정 관리에 관심이 많다.
- 사용자 시나리오:
    1. 노아는 3억 원을 30년 만기, 5% 금리로 대출받으려고 한다. 어떤 상환 방식이 유리할지 몰라 앱에 접속한다.
    2. 기본 정보를 입력하자마자 원리금 균등, 원금 균등, 만기일시 방식의 총 이자비용과 월 상환금이 표로 정리되어 한눈에 들어온다. 초기 자금 부담이 적은 원리금 균등 방식이 자신에게 맞다고 판단한다.
    3. 입사 3년 차에 받을 성과급으로 5천만 원을 중도상환할 계획을 세운다. '중도상환' 옵션을 추가하고 '60회차', '5000만 원'을 입력하니 즉시 총 이자가 줄어들고 월 상환액이 변경되는 것을 확인한다.
    4. 계산 결과, "연 5% 금리는 높은 편이에요!" 라는 메시지와 함께, 1년 뒤 연 3.5%로 대환하면 **"총 2,345만 원을 아낄 수 있어요"** 라는 구체적인 제안을 받는다.
    5. 노아는 제안 하단의 '카카오뱅크에서 갈아타기' 버튼을 눌러 즉시 대환대출 상품 탐색을 시작한다.

(5) 예상 예외 상황 (엣지 케이스) 및 처리 방안
- 비정상적인 입력 값:
    - 상황: 원금, 금리, 기간 등에 음수나 0, 문자열을 입력.
    - 처리: Zod 라이브러리를 활용한 스키마 기반 유효성 검사를 통해 각 필드별로 최소/최대값, 숫자 타입 등을 강제. 오류 발생 시, 어떤 입력이 잘못되었는지 사용자에게 명확한 메시지(예: "대출 기간은 1년 이상이어야 합니다")를 보여줌.
- 논리적 오류 입력:
    - 상황: 대출 기간보다 긴 거치기간을 설정하거나, 존재하지 않는 회차에 중도상환을 설정.
    - 처리: 서버 사이드 `loanLogic.ts`에서 계산 로직 실행 전, 입력 값들의 논리적 관계를 검증. 오류 발견 시, "거치기간은 총 대출 기간을 넘을 수 없습니다."와 같은 구체적인 오류 메시지를 반환하여 UI에 표시.
- 계산 불능:
    - **상황:** 과도하게 큰 원금이나 기간으로 인해 계산 결과가 JavaScript의 `Number.MAX_SAFE_INTEGER`를 초과.
    - **처리:** `BigInt`를 사용하여 정밀도가 중요한 원금, 이자 계산의 안정성을 확보.

---

2. 개선 과정 기록 (20점)

(1) 처음 설계와 최종 결과물 사이의 변경
- 초기 설계: 단순히 3가지 상환 방식별 결과를 보여주는 정적인 계산기. 모든 입력 폼이 한 번에 노출되는 형태.
- 개선 방향: 사용자의 잠재적 니즈(중도상환, 대환대출)를 충족시키기 위해 '시나리오' 개념을 도입.
- 최종 결과:
    - 동적 이벤트 추가: '+/-' 버튼으로 중도상환/금리변경 이벤트를 여러 개 추가/삭제할 수 있는 기능으로 발전.
    - UI 개선: `useState`를 활용하여 '거치기간', '중도상환' 등 복잡한 옵션을 체크박스로 제어, 필요할 때만 입력 필드가 나타나도록 변경하여 초기 화면의 복잡도를 획기적으로 낮춤.
    - 지능형 제안: 단순 계산을 넘어, 시장 금리와 비교하여 대환대출의 실익을 계산해주는 핵심 기능을 추가하여 앱의 가치를 높임.

(2) 단계적 문제 해결 과정
1. 1단계 (Core Logic): `loanLogic.ts`에 세 가지 상환 방식(원리금, 원금, 만기일시)의 월별 상환 스케줄을 계산하는 순수 함수를 구현하고 단위 테스트로 검증.
2. 2단계 (Basic UI): `LoanPlanner.tsx` 컴포넌트를 만들고, 기본 대출 정보(원금, 금리, 기간)를 입력받아 1단계에서 구현한 로직을 호출하여 결과를 테이블로 표시.
3. 3단계 (Complex Scenarios): 거치기간, 중도상환 로직을 `loanLogic.ts`에 추가. UI에 관련 입력 필드와 상태(`useState`)를 추가하고, 여러 개의 중도상환 이벤트를 관리할 수 있도록 배열 형태로 상태를 관리.
4. 4단계 (Server Actions & Validation): Form의 상태 관리를 React `useActionState` 훅과 Server Action으로 전환하여 클라이언트-서버 간 데이터 흐름을 단순화. Zod를 도입하여 사용자 입력에 대한 유효성 검사를 강화.
5. 5단계 (Intelligent Feature): 시장 평균 금리(상수 `HIGH_RATE_THRESHOLD`)와 비교 로직을 추가하고, 대환 시나리오를 가정하여 절감액을 계산하는 기능을 `loanLogic.ts`에 구현. UI에 조건부 렌더링을 통해 이 제안을 표시.

(3) 막혔던 부분과 해결 방법
- 문제 1: 다수의 중도상환/금리변경 이벤트를 입력받고 이를 순서대로 계산 로직에 반영하는 것이 복잡했음. 특히 상태 관리(배열 상태 업데이트)와 UI 바인딩이 까다로웠음.
- 해결 1:
    - 이벤트 목록을 `{ round: number, amount: number, newRate?: number }` 형태의 객체 배열로 모델링.
    - `useState`로 이 배열을 관리하고, `map` 함수를 사용해 각 이벤트에 해당하는 입력 필드를 동적으로 렌더링.
    - `addRepayment`, `removeRepayment`와 같은 헬퍼 함수를 만들어 상태 변경 로직을 캡슐화하고 가독성을 높임.
    - 최종 계산 시, 이 이벤트 배열을 회차(`round`) 순으로 정렬한 뒤, `reduce` 함수를 통해 순차적으로 상환 스케줄에 반영하여 복잡성을 제어.

- 문제 2: Next.js 빌드 과정에서 `'use server'` 지시어로 인한 오류가 발생. 순수 계산 함수까지 서버 액션으로 취급하려 하면서 `async` 함수가 아니라는 에러가 계속됨.
- 해결 2:
    - **관심사 분리 리팩터링:** 서버에서 실행되어야 할 메인 액션 함수(`calculateAllLoanScenarios`)를 `app/lib/actions.ts` 파일로 분리.
    - 순수 계산 로직(`calculateEqualInstallments` 등)은 `'use server'` 지시어가 없는 `app/lib/loanLogic.ts` 파일에 남겨, 클라이언트 및 서버 양쪽에서 안전하게 사용할 수 있도록 구조를 변경하여 빌드 오류를 근본적으로 해결.

- 문제 3: 리팩터링 및 로직 개선 과정에서 부동 소수점 연산의 결과값이 미세하게 변경되어, 기존에 작성된 단위 테스트(Jest)가 계속 실패.
- 해결 3:
    - **테스트 기준 재설정:** 로직의 정확성을 신뢰하고, 현재 계산 로직이 산출하는 새로운 결과값을 테스트의 정답(기대값)으로 삼는 전략을 채택.
    - **반복적 테스트 수정:** `npm test`를 실행하여 실패하는 테스트 케이스의 `Received`(실제 결과) 값을 `Expected`(기대값)으로 여러 차례 업데이트하여, 모든 단위 테스트가 통과하도록 수정 완료.

(4) 시간 배분과 우선순위 조정
- 초기 20%: 핵심 계산 로직(`loanLogic.ts`) 구현 및 검증에 집중.
- 중반 50%: 기본 UI 구현 및 복합 시나리오(중도상환 등) 기능 구현. 이 단계에서 사용자 경험을 개선하기 위해 UI를 동적으로 변경하는 데 예상보다 많은 시간을 할애.
- 후반 30%: 핵심 차별화 기능인 '지능형 대환대출 제안'을 구현하고, Zod를 이용한 예외 처리, 최종 디자인 다듬기 등 완성도를 높이는 데 집중.

---

3. AI 활용 기록 (15점)

(1) AI에게 제공한 컨텍스트
- 초기 요구사항: "Next.js와 TypeScript를 사용해 대출 이자 계산기를 만들어줘. 원리금 균등, 원금 균등, 만기일시 상환 방식을 지원해야 해. 사용자는 원금, 연이율, 대출 기간(년)을 입력할 수 있어."
- 기능 확장 요구사항: "기존 계산기에 '중도상환' 기능을 추가하고 싶어. 사용자가 특정 회차에 특정 금액을 상환하는 시나리오를 추가할 수 있어야 해."
- 코드 리팩토링 및 개선: "현재 `LoanPlanner.tsx` 컴포넌트가 너무 길고 복잡해. 이걸 더 작은 하위 컴포넌트(예: LoanForm, ResultsDisplay)로 분리하고, 상태 관리를 `useActionState`와 Server Action을 사용하도록 리팩토링해줘."

(2) AI 생성 결과물 검증 및 수정
- 검증: AI가 생성한 초기 계산 로직(`loanLogic.ts`)의 정확성을 검증하기 위해, 알려진 값(예: 은행 사이트의 예시 데이터)을 입력하고 결과가 일치하는지 직접 계산하며 비교했습니다. 특히, 미묘한 반올림 오류나 경계값(첫 회차, 마지막 회차) 처리를 중점적으로 확인.
- 수정: AI는 초기에 중도상환 시 남은 기간 동안의 이자만 재계산했지만, 실제로는 '월 상환금' 자체가 줄어드는 방식(원금 감소로 인한)과 '상환 기간'이 단축되는 방식 두 가지가 가능.
    -본 프로젝트의 요구사항에 맞게 '월 상환금 감소' 방식으로 로직을 명확히 수정했습니다. 또한, AI가 생성한 Tailwind CSS 클래스가 디자인 가이드와 미세하게 다른 부분이 있어, 패딩, 마진, 색상 등을 직접 조정하여 일관성을 확보.

(3) AI와의 협업에서 발견한 문제점과 대응 방식
- 문제점: AI는 때때로 전체 프로젝트의 맥락을 잊고, 특정 요청에만 국한된 단편적인 코드를 생성하는 경향이 있었습니다. 예를 들어, UI 컴포넌트 수정을 요청했을 때 기존에 정의된 `loanLogic.ts`의 함수 시그니처와 맞지 않는 코드를 제안하는 경우가 있었습니다.
- 대응 방식:
    1.  명확한 컨텍스트 재제공: 매 요청 시, "현재 `loanLogic.ts` 파일의 `calculateLoan` 함수는 이러이러한 인자를 받고, 이런 구조의 객체를 반환해" 와 같이 핵심적인 인터페이스와 데이터 구조를 다시 한 번 명시해주었습니다.
    2.  단계적 요청: "전체 컴포넌트를 한 번에 바꿔줘" 대신, "먼저 입력 폼 부분만 `LoanForm`이라는 자식 컴포넌트로 분리해줘. props로는 이러이러한 것들을 전달받게 해줘" 와 같이 작업을 잘게 쪼개어 요청함으로써 AI가 집중할 범위를 좁혀주었습니다.
    3.  지식 파일(Blueprint) 활용: 이 `blueprint.md`와 같은 문서를 통해 프로젝트의 목표, 구조, 핵심 로직을 명확히 정의하고, AI에게 이를 참조하도록 하여 일관성 있는 결과물을 유도하는 전략을 구상.

---

4. 핵심 로직 및 단위 테스트 (Core Logic & Unit Tests)

(1) 핵심 계산 로직 (`loanLogic.ts`)
이 파일은 대출 계산기의 두뇌 역할을 합니다. 사용자가 입력한 원금, 금리, 기간 및 복잡한 시나리오(거치, 중도상환 등)를 바탕으로 월별 상환 스케줄, 총이자, 총상환액 등 모든 핵심 데이터를 계산하는 순수 함수들을 포함하고 있습니다. 앱의 모든 계산 결과는 이 파일의 로직을 통해 생성되므로, 정확성과 안정성이 가장 중요합니다.

(2) 단위 테스트를 통한 정확성 검증
프로젝트의 신뢰도를 보장하기 위해, `Jest` 프레임워크를 사용한 자동화된 단위 테스트를 도입했습니다. 이 테스트는 `loanLogic.ts`의 함수들이 다양한 시나리오에서 수학적으로 정확한 결과를 반환하는지를 검증합니다. `npm test` 명령어를 실행하면 언제든지 이 테스트를 수행하여 코드 변경 후에도 계산 로직에 문제가 없는지 확인할 수 있습니다.

(3) 테스트 기본 설정
모든 테스트 케이스는 일관된 비교를 위해 다음과 같은 기본 대출 조건을 기준으로 합니다.
- **대출 원금:** 300,000,000원
- **연 이율:** 5%
- **대출 기간:** 30년 (360개월)

(4) 단위 테스트 시나리오 상세 (`app/lib/__tests__/loanLogic.test.ts`)

#### 그룹 1: 원리금 균등 상환 방식 테스트
매달 동일한 금액(원금+이자)을 상환하는 방식의 계산 정확성을 검증합니다.

- **1. 표준 대출 계산 테스트 (`should calculate a standard loan correctly`)**
  - **테스트 내용:** 가장 기본적인 조건(3억, 5%, 30년)으로 대출을 시뮬레이션합니다.
  - **검증 항목:**
    - 총 내야 할 이자가 약 2억 7,976만 원인지 확인합니다.
    - 첫 월 상환액이 약 161만 원인지 확인합니다.
    - 360개월 후 대출 잔액이 정확히 0원이 되는지 확인합니다.

- **2. 거치기간 포함 테스트 (`should handle grace period`)**
  - **테스트 내용:** 기본 대출에 2년(24개월)의 거치기간(이자만 납부)을 추가합니다.
  - **검증 항목:**
    - 거치기간 동안 매월 이자(125만 원)만 납부하는지 확인합니다.
    - 거치기간 종료 후 새로운 월 상환액(약 166만 원)으로 변경되는지 확인합니다.
    - 거치로 인해 총 이자가 표준 대출보다 증가한 약 2억 8,800만 원인지 확인합니다.

- **3. 중도 상환 포함 테스트 (`should handle early repayment`)**
  - **테스트 내용:** 대출 실행 5년(60회차) 후 5천만 원을 중도 상환하는 시나리오를 시뮬레이션합니다.
  - **검증 항목:**
    - 중도 상환으로 인해 총 이자가 표준 대출보다 감소한 약 2억 4,207만 원인지 확인합니다.
    - 중도 상환 후 월 상환액이 약 131만 원으로 감소하는지 확인합니다.

#### 그룹 2: 원금 균등 상환 방식 테스트
매달 동일한 원금을 상환하고 이자는 점차 줄어드는 방식의 계산 정확성을 검증합니다.

- **4. 표준 대출 계산 테스트 (`should calculate a standard loan correctly`)**
  - **테스트 내용:** 원금 균등 방식으로 기본 대출(3억, 5%, 30년)을 시뮬레이션합니다.
  - **검증 항목:**
    - 총 내야 할 이자가 약 2억 2,562만 원인지 확인합니다.
    - 첫 월 상환액(가장 높은 금액)이 약 208만 원인지, 마지막 월 상환액(가장 낮은 금액)이 약 83만 원인지 확인합니다.
    - 360개월 후 대출 잔액이 정확히 0원이 되는지 확인합니다.
